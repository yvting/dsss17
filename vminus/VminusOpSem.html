<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href="common/css/sf.css" rel="stylesheet" type="text/css"/>
<title>VminusOpSem</title>
</head>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/plf.css" rel="stylesheet" type="text/css"/>

<body>

<div id="page">

<div id="header">
<a href='https://www.cis.upenn.edu/~bcpierce/sf/current/index.html'>
<img src='common/media/image/sf_logo_sm.png'></a>
<ul id='menu'>
   <a href='index.html'><li class='section_name'>VMinus Development</li></a>
   <a href='toc.html'><li>Table of Contents</li></a>
   <a href='coqindex.html'><li>Index</li></a>
   <a href='deps.html'><li>Roadmap</li></a>
</ul>
</div>

<div id="main">

<h1 class="libtitle">VminusOpSem</h1>


<div class="doc">
VminusOpSem: Operational Semantics for Vminus 
</div>

<div class="doc">
<a name="lab66"></a><h1 class="section">Vminus Operational Semantics</h1>

<div class="paragraph"> </div>

 This file provides both relational and executable definitions of
    the Vminus operational semantics and proves them equivalent.

<div class="paragraph"> </div>

    We can reason about the semantics of Vminus programs using only
    the relational specification, but if we want to <i>test</i> them or
    extract an interpreter, we need to have the executable version
    too.  Once we have established that the two semantics correspond,
    it is easy to prove that the relational semantics is deterministic
    because it is equivalent to the executable semantics, which is
    given by a function.  

<div class="paragraph"> </div>

    The development is parameterized by a control-flow graph, making
    the operational semantics independent of its representation.

<div class="paragraph"> </div>

    Later, as a demonstration of using these semantics, we will prove
    the correctness of an Imp to Vminus compiler and some program  
    transformations as the Vminus level.

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Make</span> (<span class="id" type="var">Cfg</span>:<span class="id" type="var">CFG</span>).<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">Cfg</span>.<br/>

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Opsem</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab67"></a><h3 class="section">The state of a Vminus program:</h3>

<div class="paragraph"> </div>

 The local environment is a <i>partial</i> map from <span class="inlinecode"><span class="id" type="var">uid</span></span>s to 
      natural numbers. 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Module</span> <span class="id" type="var">Locals</span> := <span class="id" type="var">Make_Env</span>(<span class="id" type="var">Uid</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Notation</span> <span class="id" type="var">loc</span> := (<span class="id" type="var">Locals.t</span> (<span class="id" type="var">option</span> <span class="id" type="var">nat</span>)).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Notation</span> <span class="id" type="var">update</span> := <span class="id" type="var">Locals.update</span>.<br/>
</div>

<div class="doc">
The Vminus memory is a <i>total</i> map from addresses to 
      natural numbers.  (This is a bit artificial, but is a simplification 
      that aligns with the variant of Imp we use in this development.)
  
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Module</span> <span class="id" type="var">Memory</span> := <span class="id" type="var">Make_Env</span>(<span class="id" type="var">Addr</span>).<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Notation</span> <span class="id" type="var">mem</span> := (<span class="id" type="var">Memory.t</span> <span class="id" type="var">nat</span>).<br/>
</div>

<div class="doc">
The state packages together the memory, local environment,
      current program counter.  It also remembers the environment
      in effect at the end of the of the predecessor block, for
      use in phi instructions (see below). 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Record</span> <span class="id" type="var">state</span> := <span class="id" type="var">mkst</span> { <span class="id" type="var">st_mem</span>  : <span class="id" type="var">mem</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" type="var">st_pc</span>   : <span class="id" type="var">pc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" type="var">st_loc</span>  : <span class="id" type="var">loc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" type="var">st_ppc</span>  : <span class="id" type="var">pc</span>     <span class="comment">(*&nbsp;predecessor&nbsp;pc&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" type="var">st_ploc</span> : <span class="id" type="var">loc</span>    <span class="comment">(*&nbsp;predecessor&nbsp;locals&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab68"></a><h3 class="section">Evaluating values.</h3>

<div class="paragraph"> </div>

 Simply look up the uid in the local environment. (May fail!) 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">eval_val</span> (<span class="id" type="var">loc</span>:<span class="id" type="var">loc</span>) (<span class="id" type="var">v</span>:<span class="id" type="var">val</span>) : <span class="id" type="var">option</span> <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">v</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">val_nat</span> <span class="id" type="var">n</span> ⇒ <span class="id" type="var">Some</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">val_uid</span> <span class="id" type="var">i</span> ⇒ <span class="id" type="var">loc</span> <span class="id" type="var">i</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab69"></a><h3 class="section">Evaluating binary operations.</h3>

</div>
<div class="code code-space">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">b2n</span> (<span class="id" type="var">b</span>:<span class="id" type="var">bool</span>) := <span class="id" type="keyword">if</span> <span class="id" type="var">b</span> <span class="id" type="keyword">then</span> 1 <span class="id" type="keyword">else</span> 0.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">n2b</span> (<span class="id" type="var">n</span>:<span class="id" type="var">nat</span>) := <span class="id" type="keyword">if</span> <span class="id" type="var">n</span> <span class="id" type="keyword">then</span> <span class="id" type="var">false</span> <span class="id" type="keyword">else</span> <span class="id" type="var">true</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">bop_denote</span> (<span class="id" type="var">bop</span>:<span class="id" type="var">bop</span>) : <span class="id" type="var">nat</span> → <span class="id" type="var">nat</span> → <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">bop</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">bop_add</span> ⇒ <span class="id" type="var">plus</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">bop_sub</span> ⇒ <span class="id" type="var">minus</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">bop_mul</span> ⇒ <span class="id" type="var">mult</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">bop_eq</span> ⇒ <span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> <span class="id" type="var">m</span> ⇒ <span class="id" type="var">b2n</span> (<span class="id" type="var">beq_nat</span> <span class="id" type="var">n</span> <span class="id" type="var">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">bop_le</span> ⇒ <span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> <span class="id" type="var">m</span> ⇒ <span class="id" type="var">b2n</span> (<span class="id" type="var">leb</span> <span class="id" type="var">n</span> <span class="id" type="var">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">bop_and</span> ⇒ <span class="id" type="keyword">fun</span> <span class="id" type="var">n</span> <span class="id" type="var">m</span> ⇒ <span class="id" type="var">b2n</span> (<span class="id" type="var">n2b</span> <span class="id" type="var">n</span> &amp;&amp; <span class="id" type="var">n2b</span> <span class="id" type="var">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">eval_bop</span> (<span class="id" type="var">loc</span>:<span class="id" type="var">loc</span>) (<span class="id" type="var">bop</span>:<span class="id" type="var">bop</span>) (<span class="id" type="var">v<sub>1</sub></span> <span class="id" type="var">v<sub>2</sub></span>:<span class="id" type="var">val</span>) : <span class="id" type="var">option</span> <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">eval_val</span> <span class="id" type="var">loc</span> <span class="id" type="var">v<sub>1</sub></span>, <span class="id" type="var">eval_val</span> <span class="id" type="var">loc</span> <span class="id" type="var">v<sub>2</sub></span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">n<sub>1</sub></span>, <span class="id" type="var">Some</span> <span class="id" type="var">n<sub>2</sub></span> ⇒ <span class="id" type="var">Some</span> (<span class="id" type="var">bop_denote</span> <span class="id" type="var">bop</span> <span class="id" type="var">n<sub>1</sub></span> <span class="id" type="var">n<sub>2</sub></span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> ⇒ <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab70"></a><h3 class="section">Evaluating phi nodes</h3>
 To evaluate a phi instruction, we need to know from which 
      predecessor block control reached this phi node, as well as
      the local environment in effect at the end of that block.

<div class="paragraph"> </div>

      We look up the value associated with the predecessor label 
      in the phi arg list, and interpret it in the predecessor's 
      local environment, which are supplied to <span class="inlinecode"><span class="id" type="var">eval_phi</span></span>.
  
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">eval_phi</span> (<span class="id" type="var">ploc</span>:<span class="id" type="var">loc</span>) (<span class="id" type="var">pl</span>:<span class="id" type="var">lbl</span>) (<span class="id" type="var">pas</span>:<span class="id" type="var">list</span> <span class="id" type="var">phiarg</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="var">option</span> <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">assoc</span> <span class="id" type="var">Lbl.eq_dec</span> <span class="id" type="var">pl</span> <span class="id" type="var">pas</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">v</span> ⇒ <span class="id" type="var">eval_val</span> <span class="id" type="var">ploc</span> <span class="id" type="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> ⇒ <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab71"></a><h3 class="section">Control transfers</h3>

<div class="paragraph"> </div>

 Given the current locals and the terminator, determine
      the label of the next block to jump to (if any). 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">eval_tmn</span> (<span class="id" type="var">loc</span>:<span class="id" type="var">loc</span>) (<span class="id" type="var">t</span>:<span class="id" type="var">tmn</span>) : <span class="id" type="var">option</span> <span class="id" type="var">lbl</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">t</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">tmn_jmp</span> <span class="id" type="var">l</span> ⇒ <span class="id" type="var">Some</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">tmn_cbr</span> <span class="id" type="var">v</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">eval_val</span> <span class="id" type="var">loc</span> <span class="id" type="var">v</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">n</span> ⇒ <span class="id" type="var">Some</span> (<span class="id" type="keyword">if</span> <span class="id" type="var">n</span> <span class="id" type="keyword">then</span> <span class="id" type="var">l<sub>2</sub></span> <span class="id" type="keyword">else</span> <span class="id" type="var">l<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> ⇒ <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab72"></a><h3 class="section">Small-step, relational operational semantics</h3>

</div>
<div class="code code-space">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span> <span class="id" type="var">step</span> (<span class="id" type="var">g</span>:<span class="id" type="var">Cfg.t</span>) : <span class="id" type="var">state</span> → <span class="id" type="var">state</span> → <span class="id" type="keyword">Prop</span> :=<br/>
<br/>
&nbsp;&nbsp;| <span class="id" type="var">step_bop</span> : ∀ <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">bop</span> <span class="id" type="var">v<sub>1</sub></span> <span class="id" type="var">v<sub>2</sub></span> <span class="id" type="var">uid</span> <span class="id" type="var">n</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> (<span class="id" type="var">uid</span>, <span class="id" type="var">cmd_bop</span> <span class="id" type="var">bop</span> <span class="id" type="var">v<sub>1</sub></span> <span class="id" type="var">v<sub>2</sub></span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Some</span> <span class="id" type="var">n</span> = <span class="id" type="var">eval_bop</span> <span class="id" type="var">loc</span> <span class="id" type="var">bop</span> <span class="id" type="var">v<sub>1</sub></span> <span class="id" type="var">v<sub>2</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">g</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> (<span class="id" type="var">incr_pc</span> <span class="id" type="var">pc</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">update</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> (<span class="id" type="var">Some</span> <span class="id" type="var">n</span>)) <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(**&nbsp;Evaluate&nbsp;the&nbsp;right-hand&nbsp;side&nbsp;in&nbsp;the&nbsp;predecessor's&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local&nbsp;environment.&nbsp;<span class="inlinecode"><span class="id" type="var">lbl_of</span></span> <span class="inlinecode"><span class="id" type="var">ppc</span></span>&nbsp;is&nbsp;the&nbsp;source&nbsp;block&nbsp;of&nbsp;the&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;control-flow&nbsp;edge&nbsp;that&nbsp;we&nbsp;jumped&nbsp;from&nbsp;to&nbsp;reach&nbsp;the&nbsp;current&nbsp;block.&nbsp;*)</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id" type="var">step_phi</span> : ∀ <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">pas</span> <span class="id" type="var">uid</span> <span class="id" type="var">n</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> (<span class="id" type="var">uid</span>, <span class="id" type="var">cmd_phi</span> <span class="id" type="var">pas</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Some</span> <span class="id" type="var">n</span> = <span class="id" type="var">eval_phi</span> <span class="id" type="var">ploc</span> (<span class="id" type="var">lbl_of</span> <span class="id" type="var">ppc</span>) <span class="id" type="var">pas</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">g</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> (<span class="id" type="var">incr_pc</span> <span class="id" type="var">pc</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">update</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> (<span class="id" type="var">Some</span> <span class="id" type="var">n</span>)) <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(**&nbsp;Find&nbsp;the&nbsp;successor&nbsp;block&nbsp;(if&nbsp;any),&nbsp;update&nbsp;the&nbsp;pc.&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Record&nbsp;the&nbsp;current&nbsp;pc&nbsp;and&nbsp;locals&nbsp;as&nbsp;the&nbsp;"predecessor"&nbsp;state<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;use&nbsp;by&nbsp;any&nbsp;<span class="inlinecode"><span class="id" type="var">phi</span></span>&nbsp;nodes&nbsp;in&nbsp;the&nbsp;successor&nbsp;block.&nbsp;*)</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id" type="var">step_tmn</span> : ∀ <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">l'</span> <span class="id" type="var">loc</span> <span class="id" type="var">tmn</span> <span class="id" type="var">uid</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> (<span class="id" type="var">uid</span>, <span class="id" type="var">cmd_tmn</span> <span class="id" type="var">tmn</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Some</span> <span class="id" type="var">l'</span> = <span class="id" type="var">eval_tmn</span> <span class="id" type="var">loc</span> <span class="id" type="var">tmn</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">g</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> (<span class="id" type="var">block_entry</span> <span class="id" type="var">l'</span>) <span class="id" type="var">loc</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span>)<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(**&nbsp;Loads&nbsp;and&nbsp;stores&nbsp;simply&nbsp;read&nbsp;from/write&nbsp;to&nbsp;the&nbsp;memory&nbsp;component&nbsp;of&nbsp;the&nbsp;state.&nbsp;**)</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id" type="var">step_load</span> : ∀ <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> <span class="id" type="var">addr</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> (<span class="id" type="var">uid</span>, <span class="id" type="var">cmd_load</span> <span class="id" type="var">addr</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">g</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> (<span class="id" type="var">incr_pc</span> <span class="id" type="var">pc</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">update</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> (<span class="id" type="var">Some</span> (<span class="id" type="var">mem</span> <span class="id" type="var">addr</span>))) <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id" type="var">step_store</span> : ∀ <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> <span class="id" type="var">addr</span> <span class="id" type="var">v</span> <span class="id" type="var">n</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">insn_at_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span> (<span class="id" type="var">uid</span>, <span class="id" type="var">cmd_store</span> <span class="id" type="var">addr</span> <span class="id" type="var">v</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Some</span> <span class="id" type="var">n</span> = <span class="id" type="var">eval_val</span> <span class="id" type="var">loc</span> <span class="id" type="var">v</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">g</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mkst</span> (<span class="id" type="var">Memory.update</span> <span class="id" type="var">mem</span> <span class="id" type="var">addr</span> <span class="id" type="var">n</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">incr_pc</span> <span class="id" type="var">pc</span>) <span class="id" type="var">loc</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>).<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab73"></a><h3 class="section">Definition of the initial state.</h3>

<div class="paragraph"> </div>

 The initial state starts with the program counter at the beginning of the
     entry block in an empty environment.  The "predecessor state" can be 
     set arbitrarily &mdash; we will prove that in any well-formed CFG, the 
     entry block cannot have any phi nodes. 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">init_state</span> (<span class="id" type="var">g</span>:<span class="id" type="var">Cfg.t</span>) (<span class="id" type="var">m</span>: <span class="id" type="var">mem</span>) : <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">mkst</span> <span class="id" type="var">m</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">block_entry</span> (<span class="id" type="var">entry_block</span> <span class="id" type="var">g</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Locals.empty</span> <span class="id" type="var">None</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">block_entry</span> (<span class="id" type="var">entry_block</span> <span class="id" type="var">g</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Locals.empty</span> <span class="id" type="var">None</span>)).<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab74"></a><h1 class="section">Small-step, executable operational semantics</h1>

<div class="paragraph"> </div>

 This version of the semantics is just a straight forward interpreter, 
      implemented monadically in an error monad to deal with partiality. 

<div class="paragraph"> </div>

      It uses <span class="inlinecode"><span class="id" type="var">fetch</span></span> where the relational specification uses <span class="inlinecode"><span class="id" type="var">insn_at_pc</span></span>, but
      is otherwise a fairly direct transliteration of the relational version.

<div class="paragraph"> </div>

      Note: the monad notation and definitions come from <span class="inlinecode"><span class="id" type="var">Classes.v</span></span>, a 
      general purpose library that collects together some commonly used
      typeclasses and instances.

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="var">mret</span></span> is the "return" of a monad    

</li>
<li> the notation  <span class="inlinecode">'<span class="id" type="var">x</span></span> <span class="inlinecode">&lt;-</span> <span class="inlinecode"><span class="id" type="var">e<sub>1</sub></span>;</span> <span class="inlinecode"><span class="id" type="var">e<sub>2</sub></span></span> is the "bind"

</li>
<li> <span class="inlinecode"><span class="id" type="var">trywith</span></span> lifts the <span class="inlinecode"><span class="id" type="var">option</span></span> monad into the <span class="inlinecode"><span class="id" type="var">err</span></span> monad

</li>
</ul>
  <hr/>
 
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">eval_step</span> (<span class="id" type="var">g</span> : <span class="id" type="var">Cfg.t</span>) (<span class="id" type="var">s</span> : <span class="id" type="var">state</span>) : <span class="id" type="var">err</span> <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> '<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span> := <span class="id" type="var">s</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;'(<span class="id" type="var">uid</span>, <span class="id" type="var">insn</span>) &lt;- <span class="id" type="var">trywith</span> "no instruction fetched" (<span class="id" type="var">Cfg.fetch</span> <span class="id" type="var">g</span> <span class="id" type="var">pc</span>); <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">insn</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">cmd_bop</span> <span class="id" type="var">bop</span> <span class="id" type="var">v<sub>1</sub></span> <span class="id" type="var">v<sub>2</sub></span> ⇒    <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id" type="var">n</span> &lt;- <span class="id" type="var">trywith</span> "cannot evalute binop command"  (<span class="id" type="var">eval_bop</span> <span class="id" type="var">loc</span> <span class="id" type="var">bop</span> <span class="id" type="var">v<sub>1</sub></span> <span class="id" type="var">v<sub>2</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mret</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> (<span class="id" type="var">incr_pc</span> <span class="id" type="var">pc</span>) (<span class="id" type="var">update</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> (<span class="id" type="var">Some</span> <span class="id" type="var">n</span>)) <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">cmd_phi</span> <span class="id" type="var">pas</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id" type="var">n</span> &lt;- <span class="id" type="var">trywith</span> "cannot evaluate phi" (<span class="id" type="var">eval_phi</span> <span class="id" type="var">ploc</span> (<span class="id" type="var">lbl_of</span> <span class="id" type="var">ppc</span>) <span class="id" type="var">pas</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mret</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> (<span class="id" type="var">incr_pc</span> <span class="id" type="var">pc</span>) (<span class="id" type="var">update</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> (<span class="id" type="var">Some</span> <span class="id" type="var">n</span>)) <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">cmd_tmn</span> <span class="id" type="var">tmn</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id" type="var">l'</span> &lt;- <span class="id" type="var">trywith</span> "cannot evaluate terminator" (<span class="id" type="var">eval_tmn</span> <span class="id" type="var">loc</span> <span class="id" type="var">tmn</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mret</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> (<span class="id" type="var">block_entry</span> <span class="id" type="var">l'</span>) <span class="id" type="var">loc</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span>)<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">cmd_load</span> <span class="id" type="var">addr</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mret</span> (<span class="id" type="var">mkst</span> <span class="id" type="var">mem</span> (<span class="id" type="var">incr_pc</span> <span class="id" type="var">pc</span>) (<span class="id" type="var">update</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> (<span class="id" type="var">Some</span> (<span class="id" type="var">mem</span> <span class="id" type="var">addr</span>))) <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">cmd_store</span> <span class="id" type="var">addr</span> <span class="id" type="var">v</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id" type="var">n</span> &lt;- <span class="id" type="var">trywith</span> "cannot evaluate address to store to" (<span class="id" type="var">eval_val</span> <span class="id" type="var">loc</span> <span class="id" type="var">v</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mret</span> (<span class="id" type="var">mkst</span> (<span class="id" type="var">Memory.update</span> <span class="id" type="var">mem</span> <span class="id" type="var">addr</span> <span class="id" type="var">n</span>) (<span class="id" type="var">incr_pc</span> <span class="id" type="var">pc</span>) <span class="id" type="var">loc</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab75"></a><h3 class="section">Helper functions for many-steps of evaluation</h3>

</div>
<div class="code code-space">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">eval_until_pc</span> (<span class="id" type="var">g</span> : <span class="id" type="var">Cfg.t</span>) (<span class="id" type="var">s</span> : <span class="id" type="var">state</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">target_pc</span>: <span class="id" type="var">pc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fuel</span> : <span class="id" type="var">nat</span>): <span class="id" type="var">err</span> <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">fuel</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| 0 ⇒ <span class="id" type="var">raise</span> "eval out of fuel"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">S</span> <span class="id" type="var">n'</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<span class="id" type="var">eq_dec_pc</span> (<span class="id" type="var">st_pc</span> <span class="id" type="var">s</span>) <span class="id" type="var">target_pc</span>) <span class="id" type="keyword">then</span> <span class="id" type="var">mret</span> <span class="id" type="var">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id" type="var">s'</span> &lt;- (<span class="id" type="var">eval_step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eval_until_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">s'</span> <span class="id" type="var">target_pc</span> <span class="id" type="var">n'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">eval_past_pc</span> (<span class="id" type="var">g</span> : <span class="id" type="var">Cfg.t</span>) (<span class="id" type="var">s</span> : <span class="id" type="var">state</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">target_pc</span> : <span class="id" type="var">pc</span>) (<span class="id" type="var">fuel</span> : <span class="id" type="var">nat</span>) : <span class="id" type="var">err</span> <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id" type="var">s'</span> &lt;- <span class="id" type="var">eval_until_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">target_pc</span> <span class="id" type="var">fuel</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eval_step</span> <span class="id" type="var">g</span> <span class="id" type="var">s'</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <span class="id" type="var">eval_once_and_until_pc</span> (<span class="id" type="var">g</span> : <span class="id" type="var">Cfg.t</span>) (<span class="id" type="var">s</span> : <span class="id" type="var">state</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">target_pc</span>: <span class="id" type="var">pc</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fuel</span>: <span class="id" type="var">nat</span>) : <span class="id" type="var">err</span> <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id" type="var">s'</span> &lt;- <span class="id" type="var">eval_step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eval_until_pc</span> <span class="id" type="var">g</span> <span class="id" type="var">s'</span> <span class="id" type="var">target_pc</span> <span class="id" type="var">fuel</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab76"></a><h2 class="section">Correspondence between relational and executable definitions</h2>

<div class="paragraph"> </div>

 Given that the relational and executable semantics share most of their "core"
      functionality, it is pretty easy to prove that the two are equivalent.  
   
<div class="paragraph"> </div>

 This tactic helps drive the evaluator by looking for a hypothesis that is 
      "stuck" on a <span class="inlinecode"><span class="id" type="var">trywith</span></span> because it can't be simplified without further case
      analysis.  The tactic destructs the blocking expression, and is able to 
      automatically discharge the goal by applying one of the <span class="inlinecode"><span class="id" type="var">step</span></span> constructors,
      which is provided as an argument.
  
</div>
<div class="code code-tight">

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Ltac</span> <span class="id" type="var">eval_step_with_step</span> <span class="id" type="var">next_state</span> <span class="id" type="var">constructor_rule</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cfg_well_formed</span> <span class="id" type="var">fetched</span> :=<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">goal</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">H</span>: <span class="id" type="keyword">match</span> <span class="id" type="var">trywith</span> <span class="id" type="var">_</span> ?<span class="id" type="var">X</span> <span class="id" type="keyword">with</span> <span class="id" type="var">_</span> ⇒ <span class="id" type="var">_</span> <span class="id" type="keyword">end</span> = <span class="id" type="var">inr</span> ?<span class="id" type="var">next_state</span> |-<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">step</span> ?<span class="id" type="var">cfg</span> ?<span class="id" type="var">curr_state</span> <span class="id" type="var">next_state</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">X</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heval</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">constructor_rule</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Cfg.insn_at_pc_fetch</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">fetched</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">cfg_well_formed</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heval</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">H</span> : <span class="id" type="var">_</span> = <span class="id" type="var">inr</span> <span class="id" type="var">next_state</span> |-<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">step</span> ?<span class="id" type="var">cfg</span> ?<span class="id" type="var">curr_state</span> <span class="id" type="var">next_state</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">constructor_rule</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Cfg.insn_at_pc_fetch</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">fetched</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">cfg_well_formed</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">evaluator_sound</span>: ∀ <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Cfg.wf_cfg</span> <span class="id" type="var">g</span> → <span class="id" type="var">eval_step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> = <span class="id" type="var">inr</span> <span class="id" type="var">s'</span> → <span class="id" type="var">step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> <span class="id" type="var">wf_g</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">eval_step</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">s</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">mem</span> <span class="id" type="var">curr_pc</span> <span class="id" type="var">curr_loc</span> <span class="id" type="var">previous_pc</span> <span class="id" type="var">previous_loc</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">Cfg.fetch</span> <span class="id" type="var">g</span> <span class="id" type="var">curr_pc</span>) <span class="id" type="keyword">as</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[[<span class="id" type="var">uid</span> [<span class="id" type="var">bop</span> <span class="id" type="var">v<sub>1</sub></span> <span class="id" type="var">v<sub>2</sub></span> | <span class="id" type="var">pas</span> | <span class="id" type="var">term</span> | <span class="id" type="var">addr</span> | <span class="id" type="var">addr</span> <span class="id" type="var">v</span>]] | ] <span class="id" type="var">eqn</span>:<span class="id" type="var">fetched</span>; <span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="var">eval_step_with_step</span> <span class="id" type="var">s'</span> <span class="id" type="var">step_bop</span> <span class="id" type="var">wf_g</span> <span class="id" type="var">fetched</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eval_step_with_step</span> <span class="id" type="var">s'</span> <span class="id" type="var">step_phi</span> <span class="id" type="var">wf_g</span> <span class="id" type="var">fetched</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eval_step_with_step</span> <span class="id" type="var">s'</span> <span class="id" type="var">step_tmn</span> <span class="id" type="var">wf_g</span> <span class="id" type="var">fetched</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eval_step_with_step</span> <span class="id" type="var">s'</span> <span class="id" type="var">step_load</span> <span class="id" type="var">wf_g</span> <span class="id" type="var">fetched</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">eval_step_with_step</span> <span class="id" type="var">s'</span> <span class="id" type="var">step_store</span> <span class="id" type="var">wf_g</span> <span class="id" type="var">fetched</span> | <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>].<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Lemma</span> <span class="id" type="var">evaluator_complete</span>: ∀ <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Cfg.wf_cfg</span> <span class="id" type="var">g</span> → <span class="id" type="var">step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> → <span class="id" type="var">eval_step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> = <span class="id" type="var">inr</span> <span class="id" type="var">s'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> <span class="id" type="var">wf_g</span> <span class="id" type="var">step_rel</span>; <span class="id" type="tactic">unfold</span> <span class="id" type="var">eval_step</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">step_rel</span> <span class="id" type="keyword">as</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">bop</span> <span class="id" type="var">v<sub>1</sub></span> <span class="id" type="var">v<sub>2</sub></span> <span class="id" type="var">uid</span> <span class="id" type="var">n</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span> <span class="id" type="var">insn_at_pc_is</span> <span class="id" type="var">eval_insn_ok</span> <span class="id" type="var">s_eq</span> <span class="id" type="var">s'_eq</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">pas</span> <span class="id" type="var">uid</span> <span class="id" type="var">n</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span> <span class="id" type="var">insn_at_pc_is</span> <span class="id" type="var">eval_insn_ok</span> <span class="id" type="var">s_eq</span> <span class="id" type="var">s'_eq</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">label</span> <span class="id" type="var">loc</span> <span class="id" type="var">term</span> <span class="id" type="var">uid</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span> <span class="id" type="var">insn_at_pc_is</span> <span class="id" type="var">eval_insn_ok</span> <span class="id" type="var">s_eq</span> <span class="id" type="var">s'_eq</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> <span class="id" type="var">addr</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span> <span class="id" type="var">insn_at_pc_is</span> <span class="id" type="var">eval_insn_ok</span> <span class="id" type="var">s'_eq</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">mem</span> <span class="id" type="var">pc</span> <span class="id" type="var">loc</span> <span class="id" type="var">uid</span> <span class="id" type="var">addr</span> <span class="id" type="var">v</span> <span class="id" type="var">n</span> <span class="id" type="var">ppc</span> <span class="id" type="var">ploc</span> <span class="id" type="var">insn_at_pc_is</span> <span class="id" type="var">eval_insn_ok</span> <span class="id" type="var">s_eq</span> <span class="id" type="var">s'_eq</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Cfg.insn_at_pc_fetch</span> <span class="id" type="keyword">in</span> <span class="id" type="var">insn_at_pc_is</span>; <span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="tactic">apply</span> <span class="id" type="var">wf_g</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">insn_at_pc_is</span>; <span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">eval_insn_ok</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Theorem</span> <span class="id" type="var">evaluator_correct</span>: ∀ <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Cfg.wf_cfg</span> <span class="id" type="var">g</span> → <span class="id" type="var">eval_step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> = <span class="id" type="var">inr</span> <span class="id" type="var">s'</span> ↔ <span class="id" type="var">step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> <span class="id" type="var">wf_g</span>; <span class="id" type="tactic">split</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">revert</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s'</span> <span class="id" type="var">wf_g</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">evaluator_sound</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">evaluator_complete</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab77"></a><h1 class="section">Determinism of <span class="inlinecode"><span class="id" type="var">step</span></span></h1>

<div class="paragraph"> </div>

 A direct consequence of the equivalence between the relational and 
    functional specifications is that we can prove that <span class="inlinecode"><span class="id" type="var">step</span></span> is 
    deterministic.  

<div class="paragraph"> </div>

    Note: one can prove that <span class="inlinecode"><span class="id" type="var">step</span></span> is deterministic <i>without</i> using the
    correspondence with the evaluator, but it requires significantly more work!
    It might be informative to try doing that proof. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">step_deterministic</span> : ∀ <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s<sub>1</sub></span> <span class="id" type="var">s<sub>2</sub></span>, <span class="id" type="var">wf_cfg</span> <span class="id" type="var">g</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s<sub>1</sub></span> → <span class="id" type="var">step</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s<sub>2</sub></span> → <span class="id" type="var">s<sub>1</sub></span> = <span class="id" type="var">s<sub>2</sub></span>.<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">g</span> <span class="id" type="var">s</span> <span class="id" type="var">s<sub>1</sub></span> <span class="id" type="var">s<sub>2</sub></span> <span class="id" type="var">Hwfcfg</span> <span class="id" type="var">Hs<sub>1</sub></span> <span class="id" type="var">Hs<sub>2</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">evaluator_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hs<sub>1</sub></span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">evaluator_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hs<sub>2</sub></span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hs<sub>1</sub></span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hs<sub>2</sub></span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hs<sub>2</sub></span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Opsem</span>.<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Make</span>.<br/>
</div>

<div class="doc">
<hr/>
 <a name="lab78"></a><h2 class="section">Instantiating the operational semantics to ListCFG</h2>

<div class="paragraph"> </div>

 For interesting applications of the operational semantics, such as building
    a compiler or writing program transformations, we need to pick a concrete
    representation of the CFG module.  For this development, we use the 
    <span class="inlinecode"><span class="id" type="var">ListCFG</span></span> definition.
 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="var">Vminus.ListCFG</span>.<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">V</span> := <span class="id" type="var">Make</span> <span class="id" type="var">ListCFG.ListCFG</span>.<br/>
</div>

<div class="doc">
<hr/>
 
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a></div>

</div>

</body>
</html>